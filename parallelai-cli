#!/usr/bin/env python3
"""
ParallelAI Command Line Interface
Enterprise-grade AI swarm routing for security teams
"""

import os
import sys
import asyncio
import aiohttp
from typing import List, Dict

class ParallelAIClient:
    def __init__(self):
        self.providers = {
            'groq': {
                'url': 'https://api.groq.com/openai/v1/chat/completions',
                'key': os.getenv('GROQ_API_KEY'),
                'model': 'llama-3.3-70b-versatile'
            },
            'together': {
                'url': 'https://api.together.xyz/v1/chat/completions',
                'key': os.getenv('TOGETHER_API_KEY'),
                'model': 'mistralai/Mixtral-8x7B-Instruct-v0.1'
            },
            'openrouter': {
                'url': 'https://openrouter.ai/api/v1/chat/completions',
                'key': os.getenv('OPENROUTER_API_KEY'),
                'model': 'mistralai/mistral-7b-instruct:free'
            }
        }
    
    async def query_all(self, prompt: str) -> Dict:
        """Query all AI providers in parallel"""
        tasks = []
        for name, config in self.providers.items():
            if config['key']:
                tasks.append(self._query_provider(name, config, prompt))
        
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        compiled = {}
        for i, (name, result) in enumerate(zip(self.providers.keys(), results)):
            if isinstance(result, Exception):
                compiled[name] = {'success': False, 'error': str(result)}
            else:
                compiled[name] = {'success': True, 'response': result}
        
        return compiled
    
    async def _query_provider(self, name: str, config: Dict, prompt: str):
        """Query a single provider"""
        headers = {
            'Authorization': f'Bearer {config["key"]}',
            'Content-Type': 'application/json'
        }
        
        payload = {
            'model': config['model'],
            'messages': [{'role': 'user', 'content': prompt}],
            'max_tokens': 500,
            'temperature': 0.7
        }
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(
                    config['url'],
                    json=payload,
                    headers=headers,
                    timeout=30
                ) as response:
                    if response.status == 200:
                        data = await response.json()
                        return data['choices'][0]['message']['content']
                    else:
                        return f"Error: HTTP {response.status}"
        except Exception as e:
            return f"Error: {str(e)}"

async def main():
    if len(sys.argv) < 2:
        print("Usage: parallelai-cli \"Your query here\"")
        print("Example: parallelai-cli \"Analyze this security vulnerability\"")
        sys.exit(1)
    
    query = " ".join(sys.argv[1:])
    print(f"ðŸ” Query: {query}")
    print("ðŸ”„ Querying AI providers in parallel...\n")
    
    client = ParallelAIClient()
    results = await client.query_all(query)
    
    print("=" * 60)
    for provider, result in results.items():
        if result['success']:
            print(f"âœ… {provider.upper()}:")
            print(f"{result['response'][:200]}...")
            print("-" * 40)
        else:
            print(f"âŒ {provider.upper()}: {result.get('error', 'Unknown error')}")
    print("=" * 60)

if __name__ == "__main__":
    asyncio.run(main())
