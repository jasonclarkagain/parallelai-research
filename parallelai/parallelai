#!/usr/bin/env python3
"""
ParallelAI CLI - Multi-LLM Research Platform
"""
import sys
import asyncio
import click
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent))

from src.parallelai.key_manager import load_keys, setup_interactive, list_keys, set_api_key
from src.real_swarm import WorkingSwarm

@click.group()
def cli():
    """ParallelAI Swarm - Multi-LLM Research Platform"""
    pass

@cli.command()
@click.argument('query', required=True)
@click.option('--provider', '-p', help='Specific provider to use')
def query(query, provider):
    """Query AI providers with your question"""
    
    keys = load_keys()
    
    if provider:
        if provider not in keys or not keys[provider]:
            click.echo(f"‚ùå {provider.upper()} API key not configured")
            return
        
        click.echo(f"üîç Querying {provider.upper()}...")
        
        async def query_single():
            async with WorkingSwarm() as swarm:
                result = await swarm.query_specific(provider, query)
                
                if result.get("success"):
                    click.echo(f"\n‚úÖ {provider.upper()}:")
                    click.echo(f"üì¶ Model: {result.get('model', 'Unknown')}")
                    click.echo(f"üìù Response:")
                    click.echo("-" * 50)
                    click.echo(result["response"])
                    click.echo("-" * 50)
                else:
                    click.echo(f"‚ùå {provider.upper()}: {result.get('error', 'Unknown error')}")
        
        asyncio.run(query_single())
    else:
        # Query all available providers
        available = [p for p in keys if keys[p]]
        
        if not available:
            click.echo("‚ùå No API keys configured. Run 'parallelai keys setup'")
            return
        
        click.echo(f"üöÄ Querying {len(available)} providers...")
        
        async def query_all():
            async with WorkingSwarm() as swarm:
                results = await swarm.query_all(query)
                
                for p, r in results.items():
                    click.echo(f"\n{'='*60}")
                    if r.get("success"):
                        click.echo(f"‚úÖ {p.upper()}:")
                        click.echo(f"üì¶ Model: {r.get('model', 'Unknown')}")
                        click.echo(f"üìù Response:")
                        click.echo("-" * 40)
                        echo_text = r["response"][:500] + ("..." if len(r["response"]) > 500 else "")
                        click.echo(echo_text)
                        click.echo("-" * 40)
                    else:
                        click.echo(f"‚ùå {p.upper()}: {r.get('error', 'Unknown error')}")
        
        asyncio.run(query_all())

@cli.group()
def keys():
    """Manage API keys"""
    pass

@keys.command(name='setup')
def keys_setup():
    """Interactive API key setup"""
    setup_interactive()

@keys.command(name='list')
def keys_list():
    """List configured API keys"""
    list_keys()

@keys.command(name='set')
@click.argument('provider')
@click.argument('key')
def keys_set(provider, key):
    """Set a specific API key"""
    if set_api_key(provider, key):
        click.echo(f"‚úÖ {provider} key saved")
    else:
        click.echo(f"‚ùå Failed to save {provider} key")

if __name__ == '__main__':
    cli()
